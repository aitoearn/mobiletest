# MobileTest AI 开发工作总结

## 项目概述

**项目名称**: MobileTest AI - 移动端AI自动化测试平台

**项目目标**: 通过自然语言用例执行和断言能力，实现移动设备的智能自动化测试

**技术栈**:
- 前端: React + TypeScript + Ant Design + Vite
- 后端: Python + FastAPI + SQLAlchemy
- AI: LangGraph + 多模型 LLM 支持
- 设备控制: ADB (Android) / XCTest (iOS)

---

## 已完成功能模块

### 1. 设备管理模块

**功能描述**:
- 自动扫描和检测连接的移动设备
- 实时设备状态监控
- 设备信息展示（型号、序列号、状态）
- 设备截图获取

**关键文件**:
- `backend/app/services/scanner.py` - 设备扫描服务
- `backend/app/services/device.py` - 设备控制服务
- `frontend/src/pages/Devices/index.tsx` - 设备列表页面

### 2. 屏幕预览模块

**功能描述**:
- 基于 scrcpy 的实时屏幕投射
- WebSocket 实时通信
- 支持触摸、滑动等交互操作

**关键文件**:
- `frontend/src/components/ScrcpyPlayer.tsx` - 屏幕预览组件
- `backend/app/services/scrcpy.py` - scrcpy 服务

### 3. 自然语言对话模块

**功能描述**:
- 自然语言指令输入
- SSE 流式响应
- 打字机效果展示
- 执行步骤可视化

**关键文件**:
- `frontend/src/hooks/useChatStream.ts` - 聊天流处理 Hook
- `frontend/src/components/chat/MessageList.tsx` - 消息列表组件
- `frontend/src/components/chat/ChatInput.tsx` - 输入组件
- `backend/app/api/v1/chat.py` - 聊天 API

### 4. LLM 配置模块

**功能描述**:
- 多模型提供商支持（智谱 BigModel、ModelScope、通义千问、OpenAI）
- 预设配置快速选择
- 视觉模型和决策模型分离配置
- 连接测试功能
- URL 格式校验

**关键文件**:
- `frontend/src/pages/Settings/index.tsx` - 设置页面
- `backend/app/api/v1/settings.py` - 设置 API
- `backend/app/agent/llm/llm.py` - LLM 抽象层

### 5. 工作流管理模块

**功能描述**:
- 预定义工作流模板
- 工作流创建和编辑
- 工作流执行和监控

**关键文件**:
- `backend/app/orchestrator/runner.py` - LangGraph 编排器
- `backend/app/contracts/` - 状态契约定义

### 6. 定时任务模块

**功能描述**:
- Cron 表达式定时任务
- 任务调度和管理

**关键文件**:
- `backend/app/services/scheduler.py` - 调度服务

---

## 核心架构设计

### LangGraph 编排架构

```
用户输入 → Planner（规划器）→ Executor（执行器）→ Synthesizer（综合器）→ 输出结果
                ↓
         Checkpointer（检查点）
                ↓
         持久化存储（SQLite/PostgreSQL/Memory）
```

**特点**:
- 统一状态契约
- 持久化检查点
- 回退策略
- A/B 测试支持

### LLM 抽象层

```python
BaseLLM (抽象基类)
    ├── OpenAILLM
    ├── AnthropicLLM
    ├── QwenLLM
    ├── ZhipuLLM      # 智谱 BigModel
    └── ModelScopeLLM  # ModelScope
```

**特点**:
- 统一接口设计
- 支持流式响应
- 工具调用解析
- 配置文件驱动

### 前端组件架构

```
pages/
├── Devices/      # 设备管理
├── Test/         # 测试执行
├── Settings/     # 系统设置
└── Workflows/    # 工作流管理

components/
├── chat/         # 聊天相关组件
│   ├── MessageList.tsx
│   └── ChatInput.tsx
├── ScrcpyPlayer.tsx
└── ...

hooks/
├── useChatStream.ts  # 聊天流处理
└── ...
```

---

## 解决的技术问题

### 1. LLM 配置读取问题

**问题**: `LLMClient` 使用环境变量配置，无法读取 `config.json`

**解决方案**: 
- 添加 `_load_config()` 方法读取配置文件
- 根据 URL 自动识别提供商
- 优先使用配置文件，环境变量作为后备

### 2. 工具调用解析问题

**问题**: LLM 返回文本格式 `do(action="Launch", app="京东")`，无法解析为工具调用

**解决方案**:
- 添加正则表达式解析 `do(...)` 格式
- 支持中文应用名到包名的映射
- 在完整响应上解析，而非流式解析

### 3. URL 校验问题

**问题**: 配置文件中存在无效 URL 导致连接失败

**解决方案**:
- 前端添加 URL 格式校验
- 后端添加双重校验
- 提供预设配置避免手动输入错误

### 4. 代理配置问题

**问题**: SOCKS 代理导致连接失败

**解决方案**:
- 在 httpx 客户端中禁用代理
- 安装 `httpx[socks]` 包

---

## 应用包名映射表

| 应用名称 | 包名 |
|---------|------|
| 京东 | com.jingdong.app.mall |
| 淘宝 | com.taobao.taobao |
| 微信 | com.tencent.mm |
| 支付宝 | com.eg.android.AlipayGphone |
| 抖音 | com.ss.android.ugc.aweme |
| 快手 | com.smile.gifmaker |
| 美团 | com.sankuai.meituan |
| 拼多多 | com.xunmeng.pinduoduo |
| 微博 | com.sina.weibo |
| QQ | com.tencent.mobileqq |
| 高德地图 | com.autonavi.minimap |
| 百度地图 | com.baidu.BaiduMap |
| 网易云音乐 | com.netease.cloudmusic |
| QQ音乐 | com.tencent.qqmusic |

---

## 待开发功能

### 短期计划

1. **多设备并行测试**
   - 支持同时控制多个设备
   - 测试任务分发和结果聚合

2. **测试报告生成**
   - 自动生成测试报告
   - 支持多种格式导出（PDF、HTML）

3. **断言功能增强**
   - 视觉断言（截图对比）
   - 文本断言（OCR 识别）
   - 元素断言（UI 树解析）

### 中期计划

1. **iOS 设备支持**
   - XCTest 集成
   - iOS 设备检测和控制

2. **MCP 协议服务器**
   - 工具集成标准化
   - 第三方工具扩展

3. **数据抓取功能**
   - 屏幕内容识别
   - 数据提取和存储

### 长期计划

1. **AI 模型微调**
   - 针对移动测试场景优化
   - 自定义模型训练

2. **云端部署**
   - Docker 容器化
   - Kubernetes 集群部署
   - 弹性伸缩

---

## 项目结构

```
mobiletest/
├── backend/
│   ├── app/
│   │   ├── agent/          # AI Agent 相关
│   │   │   └── llm/        # LLM 抽象层
│   │   ├── api/            # API 路由
│   │   │   └── v1/
│   │   ├── core/           # 核心配置
│   │   ├── contracts/      # 状态契约
│   │   ├── orchestrator/   # LangGraph 编排
│   │   ├── services/       # 业务服务
│   │   └── models/         # 数据模型
│   ├── config.json         # 运行时配置
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── components/     # React 组件
│   │   ├── pages/          # 页面
│   │   ├── hooks/          # 自定义 Hooks
│   │   ├── types/          # TypeScript 类型
│   │   └── services/       # API 服务
│   ├── package.json
│   └── vite.config.ts
├── .gitignore
├── RUNNING.md              # 运行指南
└── README.md
```

---

## 运行方式

### 开发环境

```bash
# 后端
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 前端
cd frontend
npm install
npm run dev
```

### 访问地址

- 前端: http://localhost:5173
- 后端 API: http://localhost:8000
- API 文档: http://localhost:8000/docs

---

## Git 提交记录

| 提交信息 | 描述 |
|---------|------|
| feat: 优化 LLM 配置界面和添加国产模型支持 | 重构设置页面，添加智谱和 ModelScope 预设 |
| feat: 实现 LLM 文本指令解析和设备控制 | 添加 do() 格式解析，支持中文应用名映射 |
| feat: 添加设备管理和屏幕预览功能 | 实现设备扫描和 scrcpy 投屏 |
| feat: 实现自然语言对话功能 | SSE 流式响应，打字机效果 |

---

## 总结

本项目已成功实现了一个功能完整的移动端 AI 自动化测试平台核心框架。通过 LangGraph 编排架构和多模型 LLM 支持，实现了自然语言驱动的设备控制能力。项目采用前后端分离架构，代码结构清晰，易于扩展。

**主要成果**:
- ✅ 设备管理和屏幕预览
- ✅ 自然语言对话控制
- ✅ 多模型 LLM 集成
- ✅ 工作流编排框架
- ✅ 定时任务调度

**下一步重点**:
- 完善断言功能
- 增强测试报告
- 支持 iOS 设备
- 云端部署方案

---

*文档生成时间: 2025-02-14*
